title: "Effects of NMDA Receptor antagonists on social preference"
```{r setup, message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(
echo = FALSE,
message = FALSE,
warning = FALSE,
dpi = 600,
fig.retina = 2,
fig.width = 9,
fig.height = 6,
out.width = "100%"
)
# Packages
library(readxl)
library(dplyr)
library(metafor)
library(clubSandwich)
library(orchaRd)
library(ggplot2)
library(tidyr)
library(ggalluvial)
library(forcats)
library(stringr)
library(scales)
library(RColorBrewer)
set.seed(1)
# ---- User inputs ----
data_path  <- "meta_social_pref_nmda_sb.xlsx"
sheet_name <- 1
# Outputs
dir.create("figures", showWarnings = FALSE)
dir.create("tables",  showWarnings = FALSE)
# Main settings
rho_main   <- 0.5
rho_values <- c(0, 0.3, 0.5, 0.8)
# Colors
main_color <- "#9B7F87"
pastel_fill <- function(n) {
scales::alpha(
colorRampPalette(c("#9B7F87", "#F0E7EA"))(n),
0.9
)
}
save_both <- function(plot, filename_base, w = 8, h = 6, dpi = 600) {
ggsave(paste0("figures/", filename_base, ".png"), plot = plot, width = w, height = h, dpi = dpi)
ggsave(paste0("figures/", filename_base, ".pdf"), plot = plot, width = w, height = h, device = cairo_pdf)
}
# Build V with rho at exp_id level
make_V <- function(dat, rho) {
vcalc(vi, cluster = exp_id, obs = effect_id, data = dat, rho = rho)
}
# Fit multilevel model + robust SEs clustered by study_id
fit_mv <- function(dat, V, mods = NULL) {
if (is.null(mods)) {
m_raw <- rma.mv(
yi, V,
random = ~ 1 | study_id/exp_id,
method = "REML",
test   = "t",
dfs    = "contain",
data   = dat
)
} else {
m_raw <- rma.mv(
yi, V,
mods   = mods,
random = ~ 1 | study_id/exp_id,
method = "REML",
test   = "t",
dfs    = "contain",
data   = dat
)
}
m_rob <- robust(m_raw, cluster = dat$study_id, clubSandwich = TRUE, digits = 3)
list(raw = m_raw, rob = m_rob)
}
# Tidy coef table
coef_table <- function(m_rob, model_name = "model") {
b  <- coef(m_rob)
vc <- vcov(m_rob)
se <- sqrt(diag(vc))
ci <- cbind(b - 1.96*se, b + 1.96*se)
data.frame(
model = model_name,
term  = names(b),
estimate = as.numeric(b),
se = as.numeric(se),
ci_lb = as.numeric(ci[,1]),
ci_ub = as.numeric(ci[,2]),
row.names = NULL
)
}
# Orchard plots
orchard_overall_plot <- function(
m_rob,
title = "Overall effect",
xlab = "Hedges g"
) {
I2 <- round(orchaRd::i2_ml(m_rob)[1], 1)
orchard_plot(
m_rob,
group = "study_id",
k = TRUE,
g = TRUE,
xlab = xlab,
transfm = "none"
) +
scale_fill_manual(values = main_color) +
scale_colour_manual(values = main_color) +
labs(
title = title,
caption = paste0("Heterogeneity: I\u00B2 = ", I2, "%")
) +
theme_minimal(base_size = 12) +
theme(
axis.text.y  = element_blank(),
axis.ticks.y = element_blank(),
panel.border = element_rect(
color = "black",
fill = NA,
linewidth = 0.8
),
plot.caption = element_text(
hjust = 1,
size = 9,
margin = margin(t = 6)
),
plot.title.position = "panel",
plot.title = element_text(hjust = 0.5)
)
}
orchard_mod_plot <- function(m_rob, mod, title, xlab = "Hedges g") {
I2 <- round(orchaRd::i2_ml(m_rob)[1], 1)
levs <- levels(as.factor(m_rob$data[[mod]]))
cols <- setNames(pastel_fill(length(levs)), levs)
orchard_plot(
m_rob,
mod = mod,
group = "study_id",
k = TRUE,
g = TRUE,
xlab = xlab,
transfm = "none"
) +
scale_fill_manual(values = cols, name = mod) +
scale_colour_manual(values = cols, name = mod) +
labs(
title = title,
caption = paste0("Heterogeneity: I\u00B2 = ", I2, "%")
) +
theme_minimal(base_size = 12) +
theme(
panel.border = element_rect(
color = "black",
fill = NA,
linewidth = 0.8
),
plot.caption = element_text(
hjust = 1,
size = 9,
margin = margin(t = 6)
),
plot.title.position = "panel",
plot.title = element_text(hjust = 0.5)
)
}
# Evidence-map bubble grid: bubble size = k, bubble color = mean Hedges g
bubble_grid <- function(dat, xvar, yvar, title) {
df <- dat %>%
filter(!is.na(.data[[xvar]]), !is.na(.data[[yvar]])) %>%
group_by(.data[[xvar]], .data[[yvar]]) %>%
summarise(
k = n(),
mean_g = mean(yi, na.rm = TRUE),
.groups = "drop"
) %>%
rename(x = !!xvar, y = !!yvar)
ggplot(df, aes(x = x, y = y)) +
geom_point(
aes(size = k, fill = mean_g),
shape = 21,
color = "grey30",
alpha = 0.95
) +
geom_text(
aes(label = k),
size = 3,
color = "black"
) +
scale_size_continuous(
name = "Number of Effect Sizes",
range = c(6, 18)
) +
scale_fill_gradient2(
name = "Mean Hedges g",
low = muted("#9B7F87"),
mid = "white",
high = muted("#F0E7EA"),
midpoint = 0
) +
labs(title = title, x = xvar, y = yvar) +
theme_minimal(base_size = 12) +
theme(
axis.text.x = element_text(angle = 35, hjust = 1),
panel.grid.minor = element_blank()
)
}
alluv_dat <- dat_es %>%
count(species, nmda_antagonist, name = "Freq") %>%
mutate(
species = factor(species),
nmda_antagonist = factor(nmda_antagonist)
)
species_levels <- levels(alluv_dat$species)
species_cols <- setNames(pastel_fill(length(species_levels)), species_levels)
p_alluvial <- ggplot(alluv_dat, aes(axis1 = species, axis2 = nmda_antagonist, y = Freq)) +
geom_alluvium(aes(fill = species), width = 1/12, alpha = 0.85) +
geom_stratum(width = 1/7.5, fill = "grey90", color = "grey50") +
geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 3) +
scale_x_discrete(limits = c("Species", "NMDA antagonist"), expand = c(.1, .1)) +
scale_fill_manual(values = species_cols) +
labs(title = "", y = "Number of effect sizes") +
theme_minimal(base_size = 12) +
theme(panel.grid = element_blank(),
legend.position = "none",
axis.text.y  = element_blank(),
axis.ticks.y = element_blank(),
axis.title.y = element_text(margin = margin(r = -50)),
plot.title.position = "panel",
plot.title = element_text(hjust = 0.5, margin = margin(b = 6))
)
p_alluvial
save_both(p_alluvial, "alluvial_species_antagonist", w = 9, h = 6)
pA <- bubble_grid(
dat_es,
"nmda_antagonist",
"nmda_administration_route",
"Evidence map: nmda_antagonist × nmda_administration_route"
)
print(pA)
save_both(pA, "bubble_antagonist_route", w = 9, h = 6)
pB <- bubble_grid(
dat_es,
"nmda_antagonist",
"nmda_schedule",
"Evidence map: nmda_antagonist × nmda_schedule"
)
print(pB)
pB <- bubble_grid(
dat_es,
"nmda_antagonist",
"nmda_schedule",
"Evidence map: nmda_antagonist × nmda_schedule"
)
print(pB)
save_both(pB, "bubble_antagonist_schedule", w = 9, h = 6)
V_main <- make_V(dat_es, rho = rho_main)
m_overall <- fit_mv(dat_es, V_main)
print(m_overall$rob)
I2_overall <- orchaRd::i2_ml(m_overall$rob)
write.csv(data.frame(I2_total = I2_overall[1]), "tables/I2_overall.csv", row.names = FALSE)
p_orch <- orchard_overall_plot(m_overall$rob, title = "Overall effect")
p_orch
save_both(p_orch, "orchard_overall", w = 9, h = 6)
library(magick)
# Helper: center image on a fixed canvas
center_on_canvas <- function(img, canvas_w, canvas_h) {
image_extent(
img,
geometry = paste0(canvas_w, "x", canvas_h),
gravity = "center",
color = "white"
)
}
# Read images
img_alluvial <- image_read("figures/alluvial_species_antagonist.png")
img_overall  <- image_read("figures/orchard_overall.png")
img_ant      <- image_read("figures/orchard_by_nmda_antagonist.png")
img_species  <- image_read("figures/orchard_by_species.png")
# Define CANVAS size (match largest image)
info <- image_info(c(img_alluvial, img_overall, img_ant, img_species))
canvas_w <- max(info$width)
canvas_h <- max(info$height)
# Center each image
img_alluvial <- center_on_canvas(img_alluvial, canvas_w, canvas_h)
img_overall  <- center_on_canvas(img_overall,  canvas_w, canvas_h)
img_ant      <- center_on_canvas(img_ant,      canvas_w, canvas_h)
img_species  <- center_on_canvas(img_species,  canvas_w, canvas_h)
# Assemble layout
top_row    <- image_append(c(img_alluvial, img_overall))
bottom_row <- image_append(c(img_ant, img_species))
final_figure <- image_append(c(top_row, bottom_row), stack = TRUE)
# Save
image_write(
final_figure,
"figures/composite_alluvial_orchards_centered.png",
format = "png"
)
final_figure
knitr::opts_chunk$set(
echo = FALSE,
message = FALSE,
warning = FALSE,
dpi = 600,
fig.retina = 2,
fig.width = 9,
fig.height = 6,
out.width = "100%"
)
# Packages
library(readxl)
library(dplyr)
library(metafor)
library(clubSandwich)
library(orchaRd)
library(ggplot2)
library(tidyr)
library(ggalluvial)
library(forcats)
library(stringr)
library(scales)
library(RColorBrewer)
set.seed(1)
# ---- User inputs ----
data_path  <- "meta_social_pref_nmda_loc.xlsx"
sheet_name <- 1
# Outputs
dir.create("figures", showWarnings = FALSE)
dir.create("tables",  showWarnings = FALSE)
# Main settings
rho_main   <- 0.5
rho_values <- c(0, 0.3, 0.5, 0.8)
# Colors
main_color <- "#9B7F87"
pastel_fill <- function(n) {
scales::alpha(
colorRampPalette(c("#9B7F87", "#F0E7EA"))(n),
0.9
)
}
save_both <- function(plot, filename_base, w = 8, h = 6, dpi = 600) {
ggsave(paste0("figures/", filename_base, ".png"), plot = plot, width = w, height = h, dpi = dpi)
ggsave(paste0("figures/", filename_base, ".pdf"), plot = plot, width = w, height = h, device = cairo_pdf)
}
# Build V with rho at exp_id level
make_V <- function(dat, rho) {
vcalc(vi, cluster = exp_id, obs = effect_id, data = dat, rho = rho)
}
# Fit multilevel model + robust SEs clustered by study_id
fit_mv <- function(dat, V, mods = NULL) {
if (is.null(mods)) {
m_raw <- rma.mv(
yi, V,
random = ~ 1 | study_id/exp_id,
method = "REML",
test   = "t",
dfs    = "contain",
data   = dat
)
} else {
m_raw <- rma.mv(
yi, V,
mods   = mods,
random = ~ 1 | study_id/exp_id,
method = "REML",
test   = "t",
dfs    = "contain",
data   = dat
)
}
m_rob <- robust(m_raw, cluster = dat$study_id, clubSandwich = TRUE, digits = 3)
list(raw = m_raw, rob = m_rob)
}
# Tidy coef table
coef_table <- function(m_rob, model_name = "model") {
b  <- coef(m_rob)
vc <- vcov(m_rob)
se <- sqrt(diag(vc))
ci <- cbind(b - 1.96*se, b + 1.96*se)
data.frame(
model = model_name,
term  = names(b),
estimate = as.numeric(b),
se = as.numeric(se),
ci_lb = as.numeric(ci[,1]),
ci_ub = as.numeric(ci[,2]),
row.names = NULL
)
}
# Orchard plots
orchard_overall_plot <- function(
m_rob,
title = "Overall effect",
xlab = "Hedges g"
) {
I2 <- round(orchaRd::i2_ml(m_rob)[1], 1)
orchard_plot(
m_rob,
group = "study_id",
k = TRUE,
g = TRUE,
xlab = xlab,
transfm = "none"
) +
scale_fill_manual(values = main_color) +
scale_colour_manual(values = main_color) +
labs(
title = title,
caption = paste0("Heterogeneity: I\u00B2 = ", I2, "%")
) +
theme_minimal(base_size = 12) +
theme(
axis.text.y  = element_blank(),
axis.ticks.y = element_blank(),
panel.border = element_rect(
color = "black",
fill = NA,
linewidth = 0.8
),
plot.caption = element_text(
hjust = 1,
size = 9,
margin = margin(t = 6)
),
plot.title.position = "panel",
plot.title = element_text(hjust = 0.5)
)
}
orchard_mod_plot <- function(m_rob, mod, title, xlab = "Hedges g") {
I2 <- round(orchaRd::i2_ml(m_rob)[1], 1)
levs <- levels(as.factor(m_rob$data[[mod]]))
cols <- setNames(pastel_fill(length(levs)), levs)
orchard_plot(
m_rob,
mod = mod,
group = "study_id",
k = TRUE,
g = TRUE,
xlab = xlab,
transfm = "none"
) +
scale_fill_manual(values = cols, name = mod) +
scale_colour_manual(values = cols, name = mod) +
labs(
title = title,
caption = paste0("Heterogeneity: I\u00B2 = ", I2, "%")
) +
theme_minimal(base_size = 12) +
theme(
panel.border = element_rect(
color = "black",
fill = NA,
linewidth = 0.8
),
plot.caption = element_text(
hjust = 1,
size = 9,
margin = margin(t = 6)
),
plot.title.position = "panel",
plot.title = element_text(hjust = 0.5)
)
}
# Evidence-map bubble grid: bubble size = k, bubble color = mean Hedges g
bubble_grid <- function(dat, xvar, yvar, title) {
df <- dat %>%
filter(!is.na(.data[[xvar]]), !is.na(.data[[yvar]])) %>%
group_by(.data[[xvar]], .data[[yvar]]) %>%
summarise(
k = n(),
mean_g = mean(yi, na.rm = TRUE),
.groups = "drop"
) %>%
rename(x = !!xvar, y = !!yvar)
ggplot(df, aes(x = x, y = y)) +
geom_point(
aes(size = k, fill = mean_g),
shape = 21,
color = "grey30",
alpha = 0.95
) +
geom_text(
aes(label = k),
size = 3,
color = "black"
) +
scale_size_continuous(
name = "Number of Effect Sizes",
range = c(6, 18)
) +
scale_fill_gradient2(
name = "Mean Hedges g",
low = muted("#F0E7EA"),
mid = "white",
high = muted("#9B7F87"),
midpoint = 0
) +
labs(title = title, x = xvar, y = yvar) +
theme_minimal(base_size = 12) +
theme(
axis.text.x = element_text(angle = 35, hjust = 1),
panel.grid.minor = element_blank()
)
}
V_main <- make_V(dat_es, rho = rho_main)
m_overall <- fit_mv(dat_es, V_main)
print(m_overall$rob)
I2_overall <- orchaRd::i2_ml(m_overall$rob)
write.csv(data.frame(I2_total = I2_overall[1]), "tables/I2_overall.csv", row.names = FALSE)
p_orch <- orchard_overall_plot(m_overall$rob, title = "Overall effect")
p_orch
save_both(p_orch, "orchard_overall", w = 9, h = 6)
