knitr::opts_chunk$set(
echo = FALSE,
message = FALSE,
warning = FALSE,
dpi = 600,
fig.retina = 2,
fig.width = 9,
fig.height = 6,
out.width = "100%"
)
# Packages
library(readxl)
library(dplyr)
library(metafor)
library(clubSandwich)
library(orchaRd)
library(ggplot2)
library(tidyr)
library(ggalluvial)
library(forcats)
library(stringr)
library(scales)
library(RColorBrewer)
set.seed(1)
# ---- User inputs ----
data_path  <- "meta_social_pref_nmda_loc.xlsx"
sheet_name <- 1
# Outputs
dir.create("figures", showWarnings = FALSE)
dir.create("tables",  showWarnings = FALSE)
# Main settings
rho_main   <- 0.5
rho_values <- c(0, 0.3, 0.5, 0.8)
# Colors
main_color <- "#9B7F87"
pastel_fill <- function(n) {
scales::alpha(
colorRampPalette(c("#9B7F87", "#F0E7EA"))(n),
0.9
)
}
save_both <- function(plot, filename_base, w = 8, h = 6, dpi = 600) {
ggsave(paste0("figures/", filename_base, ".png"), plot = plot, width = w, height = h, dpi = dpi)
ggsave(paste0("figures/", filename_base, ".pdf"), plot = plot, width = w, height = h, device = cairo_pdf)
}
# Build V with rho at exp_id level
make_V <- function(dat, rho) {
vcalc(vi, cluster = exp_id, obs = effect_id, data = dat, rho = rho)
}
# Fit multilevel model + robust SEs clustered by study_id
fit_mv <- function(dat, V, mods = NULL) {
if (is.null(mods)) {
m_raw <- rma.mv(
yi, V,
random = ~ 1 | study_id/exp_id,
method = "REML",
test   = "t",
dfs    = "contain",
data   = dat
)
} else {
m_raw <- rma.mv(
yi, V,
mods   = mods,
random = ~ 1 | study_id/exp_id,
method = "REML",
test   = "t",
dfs    = "contain",
data   = dat
)
}
m_rob <- robust(m_raw, cluster = dat$study_id, clubSandwich = TRUE, digits = 3)
list(raw = m_raw, rob = m_rob)
}
# Tidy coef table
coef_table <- function(m_rob, model_name = "model") {
b  <- coef(m_rob)
vc <- vcov(m_rob)
se <- sqrt(diag(vc))
ci <- cbind(b - 1.96*se, b + 1.96*se)
data.frame(
model = model_name,
term  = names(b),
estimate = as.numeric(b),
se = as.numeric(se),
ci_lb = as.numeric(ci[,1]),
ci_ub = as.numeric(ci[,2]),
row.names = NULL
)
}
# Orchard plots
orchard_overall_plot <- function(
m_rob,
title = "Overall effect",
xlab = "Hedges g"
) {
I2 <- round(orchaRd::i2_ml(m_rob)[1], 1)
orchard_plot(
m_rob,
group = "study_id",
k = TRUE,
g = TRUE,
xlab = xlab,
transfm = "none"
) +
scale_fill_manual(values = main_color) +
scale_colour_manual(values = main_color) +
labs(
title = title,
caption = paste0("Heterogeneity: I\u00B2 = ", I2, "%")
) +
theme_minimal(base_size = 12) +
theme(
axis.text.y  = element_blank(),
axis.ticks.y = element_blank(),
panel.border = element_rect(
color = "black",
fill = NA,
linewidth = 0.8
),
plot.caption = element_text(
hjust = 1,
size = 9,
margin = margin(t = 6)
),
plot.title.position = "panel",
plot.title = element_text(hjust = 0.5)
)
}
orchard_mod_plot <- function(m_rob, mod, title, xlab = "Hedges g") {
I2 <- round(orchaRd::i2_ml(m_rob)[1], 1)
levs <- levels(as.factor(m_rob$data[[mod]]))
cols <- setNames(pastel_fill(length(levs)), levs)
orchard_plot(
m_rob,
mod = mod,
group = "study_id",
k = TRUE,
g = TRUE,
xlab = xlab,
transfm = "none"
) +
scale_fill_manual(values = cols, name = mod) +
scale_colour_manual(values = cols, name = mod) +
labs(
title = title,
caption = paste0("Heterogeneity: I\u00B2 = ", I2, "%")
) +
theme_minimal(base_size = 12) +
theme(
panel.border = element_rect(
color = "black",
fill = NA,
linewidth = 0.8
),
plot.caption = element_text(
hjust = 1,
size = 9,
margin = margin(t = 6)
),
plot.title.position = "panel",
plot.title = element_text(hjust = 0.5)
)
}
# Evidence-map bubble grid: bubble size = k, bubble color = mean Hedges g
bubble_grid <- function(dat, xvar, yvar, title) {
df <- dat %>%
filter(!is.na(.data[[xvar]]), !is.na(.data[[yvar]])) %>%
group_by(.data[[xvar]], .data[[yvar]]) %>%
summarise(
k = n(),
mean_g = mean(yi, na.rm = TRUE),
.groups = "drop"
) %>%
rename(x = !!xvar, y = !!yvar)
ggplot(df, aes(x = x, y = y)) +
geom_point(
aes(size = k, fill = mean_g),
shape = 21,
color = "grey30",
alpha = 0.95
) +
geom_text(
aes(label = k),
size = 3,
color = "black"
) +
scale_size_continuous(
name = "Number of Effect Sizes",
range = c(6, 18)
) +
scale_fill_gradient2(
name = "Mean Hedges g",
low = muted("#F0E7EA"),
mid = "white",
high = muted("#9B7F87"),
midpoint = 0
) +
labs(title = title, x = xvar, y = yvar) +
theme_minimal(base_size = 12) +
theme(
axis.text.x = element_text(angle = 35, hjust = 1),
panel.grid.minor = element_blank()
)
}
pi_overall <- predict(
m_overall$rob,
pi = TRUE,
digits = 3
)
